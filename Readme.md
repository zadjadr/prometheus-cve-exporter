[![Test](https://github.com/zadjadr/prometheus-cve-exporter/actions/workflows/test.yaml/badge.svg)](https://github.com/zadjadr/prometheus-cve-exporter/actions/workflows/test.yaml)

# Prometheus CVE Exporter

Prometheus CVE Exporter is a Golang application that scans your system for all installed packages and compares them with the recent [NVD JSON feed](https://nvd.nist.gov/vuln/data-feeds#JSON_FEED). It exports metrics that provide insights into the security status of your packages.

## TOC

- [Prometheus CVE Exporter](#prometheus-cve-exporter)
  * [Features](#features)
  * [Exported Metrics](#exported-metrics)
    + [Example output](#example-output)
  * [Building](#building)
    + [Prerequisites](#prerequisites)
    + [Steps](#steps)
  * [Usage](#usage)
    + [Binary without config](#binary-without-config)
    + [Binary with config](#binary-with-config)
    + [Docker](#docker)

## Features

- **Vulnerability Detection**: Identifies installed packages that have known vulnerabilities.
- **Prometheus Metrics**: Exports detailed metrics to Prometheus for monitoring and alerting.
- **Automated Updates**: Regularly fetches the latest NVD JSON feed to ensure up-to-date vulnerability information.

## Exported Metrics

| Metric Name                   | Type      | Description                                             | Labels                                      |
|-------------------------------|-----------|---------------------------------------------------------|---------------------------------------------|
| `nvd_vulnerable_packages`     | GaugeVec  | Indicates if a package is vulnerable (1) or not         | `package`, `version`, `cve`, `impact`       |
| `nvd_total_vulnerabilities`   | Gauge     | Total number of vulnerabilities detected                | None                                        |
| `nvd_last_update_time`        | Gauge     | Timestamp of the last successful update                 | None                                        |

### Example output

```
# HELP nvd_last_update_time Timestamp of the last successful update
# TYPE nvd_last_update_time gauge
nvd_last_update_time 1.7213802588068807e+09
# HELP nvd_total_vulnerabilities Total number of vulnerabilities detected
# TYPE nvd_total_vulnerabilities gauge
nvd_total_vulnerabilities 6
# HELP nvd_vulnerable_packages Indicates if a package is vulnerable (1) or not (metric not present)
# TYPE nvd_vulnerable_packages gauge
nvd_vulnerable_packages{cve="CVE-2024-21513",impact="HIGH",package="langchain-experimental",version="0.0.17"} 1
nvd_vulnerable_packages{cve="CVE-2024-6072",impact="MEDIUM",package="wp_estore",version="8.5.3"} 1
nvd_vulnerable_packages{cve="CVE-2024-6073",impact="MEDIUM",package="wp_estore",version="8.5.3"} 1
nvd_vulnerable_packages{cve="CVE-2024-6074",impact="MEDIUM",package="wp_estore",version="8.5.3"} 1
nvd_vulnerable_packages{cve="CVE-2024-6075",impact="HIGH",package="wp_estore",version="8.5.3"} 1
nvd_vulnerable_packages{cve="CVE-2024-6076",impact="MEDIUM",package="wp_estore",version="8.5.3"} 1
```

## Building

### Prerequisites

- Go 1.22 or higher

### Steps

1. **Clone the repository**:

    ```sh
    git clone https://github.com/zadjadr/prometheus-cve-exporter.git
    cd prometheus-cve-exporter
    ```

2. **Build the application**:

    ```sh
    go build -o ./bin/ ./...
    ```

3. **Run the application**:

    ```sh
    ./bin/prometheus-cve-exporter -help
    ```

Alternatively, you can download the precompiled package from the releases section on GitHub.

## Usage

The Prometheus CVE Exporter will start a web server on port `10250` by default and expose the metrics at the `/metrics` endpoint.

To customize the settings, use the following flags:

```
  -config string
        path to config file
  -nvd-feed-url string
        URL for the NVD feed (default "https://nvd.nist.gov/feeds/json/cve/1.1/nvdcve-1.1-recent.json.gz")
  -package-file string
        Path to file containing packages and versions
  -port int
        Port to run the server on (default 10250)
  -severity string
        Comma separated list of severity levels for vulnerabilities (default "CRITICAL")
  -update-interval duration
        Update interval duration (default 24h0m0s)
```

### Binary without config

```sh
./bin/prometheus-cve-exporter -port 9090 -severity "HIGH,CRITICAL" -update-interval 12h -package-file /tmp/packages.txt
```

### Binary with config

```json
{
  "package_file": "/tmp/packages.txt",
  "nvd_feed_url": "https://nvd.nist.gov/feeds/json/cve/1.1/nvdcve-1.1-recent.json.gz",
  "update_interval": "5m",
  "port": 8080,
  "severity": [
    "LOW",
    "MEDIUM",
    "HIGH",
    "CRITICAL"
  ]
}

```

```sh
./bin/prometheus-cve-exporter -config config.json
```

### Docker

Released version tags are:

- latest
- major version (e.g. `v1`)
- `major.minor` version (e.g. `v1.1`)
- tag name (e.g. `v1.0.0`)

For the docker version, you will need to provide a `package-file`, otherwise the scanner will only
scan the container.

```shell
docker run -it -v $(pwd):/app -p 10250:10250 --rm ghcr.io/zadjadr/prometheus-cve-exporter:latest -- -package-file /app/packages.txt
```

```
Current configuration:
    NVD Feed URL: https://nvd.nist.gov/feeds/json/cve/1.1/nvdcve-1.1-recent.json.gz
    Update Interval: 24h0m0s
    Severity Levels: [CRITICAL]
    Port: 10250
    Package file: packages.txt
Starting server on :10250
```
